-- 1. Pastikan tabel transactions_valid sudah ada (amount akan diisi dari saldo)
CREATE TABLE IF NOT EXISTS transactions_valid (
	no INT(11) NOT NULL,
	username VARCHAR(50) NOT NULL,
	transactioncode VARCHAR(16) NOT NULL,
	item VARCHAR(10) DEFAULT 'Deposit',
	amount DECIMAL(10,2) DEFAULT 0,  -- amount diisi dari saldo savedatabaru
	status VARCHAR(7) DEFAULT 'Success',
	inputdate DATE DEFAULT current_timestamp(),
	transactiondate DATE DEFAULT NULL,
	PRIMARY KEY (no)
);

-- 2. Pindahkan data yang cocok, amount diisi dari s.saldo (savedatabaru)
INSERT INTO transactions_valid (no, username, transactioncode, item, amount, inputdate, transactiondate, status)
SELECT t.no, t.username, t.transactioncode, t.item, s.saldo, t.inputdate, t.transactiondate, 'Success'
FROM transactions t
JOIN savedatabaru s
  ON t.transactioncode = s.transactioncode
 AND t.transactiondate = s.date;

-- 3. Update status menjadi 'Invalid' untuk data di transactions yang tidak memiliki pasangan di savedatabaru
UPDATE transactions t
LEFT JOIN savedatabaru s
  ON t.transactioncode = s.transactioncode
 AND t.transactiondate = s.date
SET t.status = 'Invalid'
WHERE s.transactioncode IS NULL
  AND t.status = 'Verify';

-- 4. Hapus data yang sudah berhasil dipindahkan dari tabel transactions
DELETE t
FROM transactions t
JOIN savedatabaru s
  ON t.transactioncode = s.transactioncode
 AND t.transactiondate = s.date;
