UPDATE users u
JOIN (
	SELECT 
	ts.username,
	COALESCE(SUM(ts.amount), 0) - COALESCE(wd.total_withdraw, 0) AS balance_result
	FROM transactions_success ts
	LEFT JOIN (
		SELECT username, SUM(amount) AS total_withdraw
		FROM transactions_wd
		WHERE status = 'Success'
		GROUP BY username
	) wd ON ts.username = wd.username
	GROUP BY ts.username
) AS result ON u.username = result.username
SET u.balance = result.balance_result;
